<div class="person-detail-container">
  @if (isLoading()) {
    <div class="loading">
      <mat-spinner></mat-spinner>
      <p>{{ 'personDetail.loading' | translate }}</p>
    </div>
  } @else if (error()) {
    <mat-card class="error-card">
      <mat-card-content>
        <i class="fa-solid fa-circle-exclamation" aria-hidden="true"></i>
        <h3>{{ 'personDetail.errorLoading' | translate }}</h3>
        <p>{{ error() }}</p>
        <button mat-raised-button color="primary" (click)="loadPerson()">{{ 'personDetail.retry' | translate }}</button>
      </mat-card-content>
    </mat-card>
  } @else if (person()) {
    <!-- Header Card -->
    <mat-card class="header-card">
      <div class="person-header">
        <app-person-avatar
          [person]="person()!"
          size="large"
          [editable]="true"
          (avatarChanged)="loadPerson()">
        </app-person-avatar>
        <div class="info">
          <h1>{{ getPersonDisplayName() }}</h1>
          <p class="lifespan">{{ getLifespan() }}</p>
          @if (person()!.occupation) {
            <p class="occupation">{{ person()!.occupation }}</p>
          }
        </div>
        <div class="actions">
          <button mat-icon-button [matMenuTriggerFor]="actionsMenu">
            <i class="fa-solid fa-ellipsis-vertical" aria-hidden="true"></i>
          </button>
          <mat-menu #actionsMenu="matMenu">
            <button mat-menu-item (click)="editPerson()">
              <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
              <span>{{ 'personDetail.actions.edit' | translate }}</span>
            </button>
            <button mat-menu-item (click)="viewInTree()">
              <i class="fa-solid fa-sitemap" aria-hidden="true"></i>
              <span>{{ 'personDetail.actions.viewInTree' | translate }}</span>
            </button>
            <button mat-menu-item (click)="deletePerson()" class="delete-action">
              <i class="fa-solid fa-trash" aria-hidden="true"></i>
              <span>{{ 'personDetail.actions.delete' | translate }}</span>
            </button>
          </mat-menu>
        </div>
      </div>
    </mat-card>

    <!-- Tabs for different sections -->
    <mat-tab-group [selectedIndex]="selectedTabIndex()"
                   (selectedIndexChange)="onTabChange($event)">
      <!-- Details Tab -->
      <mat-tab [label]="'personDetail.tabs.details' | translate">
        <mat-card class="tab-content">
          <mat-card-content>
            <div class="details-grid">
              @if (person()!.birthDate) {
                <div class="detail-item">
                  <span class="label">{{ 'personDetail.labels.birth' | translate }}</span>
                  <span class="value">
                    {{ formatDate(person()!.birthDate) }}
                    @if (person()!.birthPlace) {
                      <br><small>{{ person()!.birthPlace }}</small>
                    }
                  </span>
                </div>
              }
              @if (person()!.deathDate) {
                <div class="detail-item">
                  <span class="label">{{ 'personDetail.labels.death' | translate }}</span>
                  <span class="value">
                    {{ formatDate(person()!.deathDate) }}
                    @if (person()!.deathPlace) {
                      <br><small>{{ person()!.deathPlace }}</small>
                    }
                  </span>
                </div>
              }
              @if (person()!.gender) {
                <div class="detail-item">
                  <span class="label">{{ 'personDetail.labels.gender' | translate }}</span>
                  <span class="value">{{ person()!.gender }}</span>
                </div>
              }
              @if (person()!.nationality) {
                <div class="detail-item">
                  <span class="label">{{ 'personDetail.labels.nationality' | translate }}</span>
                  <span class="value">{{ person()!.nationality }}</span>
                </div>
              }
              @if (person()!.religion) {
                <div class="detail-item">
                  <span class="label">{{ 'personDetail.labels.religion' | translate }}</span>
                  <span class="value">{{ person()!.religion }}</span>
                </div>
              }
              @if (person()!.education) {
                <div class="detail-item">
                  <span class="label">{{ 'personDetail.labels.education' | translate }}</span>
                  <span class="value">{{ person()!.education }}</span>
                </div>
              }
            </div>

            <!-- Notes in Different Languages -->
            @if (hasAnyNotes()) {
              <div class="notes-section">
                <h4>{{ 'personDetail.labels.notes' | translate }}</h4>
                @if (person()!.notes) {
                  <div class="note-item">
                    <mat-chip>{{ 'languages.english' | translate }}</mat-chip>
                    <p>{{ person()!.notes }}</p>
                  </div>
                }
                @if (person()!.notesAr) {
                  <div class="note-item">
                    <mat-chip>{{ 'languages.arabic' | translate }}</mat-chip>
                    <p class="notes-arabic" dir="rtl">{{ person()!.notesAr }}</p>
                  </div>
                }
                @if (person()!.notesNob) {
                  <div class="note-item">
                    <mat-chip>{{ 'languages.nobiin' | translate }}</mat-chip>
                    <p>{{ person()!.notesNob }}</p>
                  </div>
                }
              </div>
            }

            <!-- Names in Different Scripts -->
            @if (hasAnyName()) {
              <div class="names-section">
                <h4>{{ 'personDetail.labels.names' | translate }}</h4>
                @if (person()!.nameArabic) {
                  <div class="name-item">
                    <mat-chip>{{ 'languages.arabic' | translate }}</mat-chip>
                    <span class="name-arabic">{{ person()!.nameArabic }}</span>
                  </div>
                }
                @if (person()!.nameEnglish) {
                  <div class="name-item">
                    <mat-chip>{{ 'languages.english' | translate }}</mat-chip>
                    <span>{{ person()!.nameEnglish }}</span>
                  </div>
                }
                @if (person()!.nameNobiin) {
                  <div class="name-item">
                    <mat-chip>{{ 'languages.nobiin' | translate }}</mat-chip>
                    <span>{{ person()!.nameNobiin }}</span>
                  </div>
                }
              </div>
            }
          </mat-card-content>
        </mat-card>
      </mat-tab>

      <!-- Family Tab -->
      <mat-tab [label]="'personDetail.tabs.family' | translate">
        <mat-card class="tab-content">
          <mat-card-content>
            <!-- Parents Section -->
            <div class="family-section">
              <div class="section-header">
                <h3>{{ 'personDetail.sections.parents' | translate }}</h3>
                <button mat-stroked-button (click)="addRelationship('parent')">
                  <i class="fa-solid fa-plus" aria-hidden="true"></i> {{ 'personDetail.actions.addParent' | translate }}
                </button>
              </div>
              @if (parents().length > 0) {
                <mat-list>
                  @for (parent of parents(); track parent.id) {
                    <mat-list-item class="clickable" (click)="navigateToPerson(parent.parentId)">
                      <i matListItemIcon class="fa-solid" [ngClass]="[getSexIconClass(parent.parentSex), getSexClass(parent.parentSex)]" aria-hidden="true"></i>
                      <span matListItemTitle>{{ getParentDisplayName(parent) }}</span>
                      <span matListItemLine>
                        {{ getRelationshipTypeLabel(parent.relationshipType) }}
                        @if (parent.isAdopted) { ({{ 'personDetail.relationshipTypes.adopted' | translate }}) }
                      </span>
                      <button mat-icon-button matListItemMeta (click)="removeParent(parent, $event)">
                        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                      </button>
                    </mat-list-item>
                  }
                </mat-list>
              } @else {
                <p class="no-data">{{ 'personDetail.noData.parents' | translate }}</p>
              }
            </div>

            <!-- Siblings Section -->
            <div class="family-section">
              <div class="section-header">
                <h3>{{ 'personDetail.sections.siblings' | translate }}</h3>
                <button mat-stroked-button (click)="addRelationship('sibling')">
                  <i class="fa-solid fa-plus" aria-hidden="true"></i> {{ 'personDetail.actions.addSibling' | translate }}
                </button>
              </div>
              @if (siblings().length > 0) {
                <mat-list>
                  @for (sibling of siblings(); track sibling.personId) {
                    <mat-list-item class="clickable" (click)="navigateToPerson(sibling.personId)">
                      <i matListItemIcon class="fa-solid" [ngClass]="[getSexIconClass(sibling.personSex), getSexClass(sibling.personSex)]" aria-hidden="true"></i>
                      <span matListItemTitle>{{ getSiblingDisplayName(sibling) }}</span>
                      <span matListItemLine>
                        {{ sibling.isFullSibling ? ('personDetail.siblingTypes.full' | translate) : ('personDetail.siblingTypes.half' | translate) }}
                      </span>
                    </mat-list-item>
                  }
                </mat-list>
              } @else {
                <p class="no-data">{{ 'personDetail.noData.siblings' | translate }}</p>
              }
            </div>

            <!-- Spouses Section -->
            <div class="family-section">
              <div class="section-header">
                <h3>{{ 'personDetail.sections.spouses' | translate }}</h3>
                <button mat-stroked-button (click)="addRelationship('spouse')">
                  <i class="fa-solid fa-plus" aria-hidden="true"></i> {{ 'personDetail.actions.addSpouse' | translate }}
                </button>
              </div>
              @if (unions().length > 0) {
                <mat-list>
                  @for (union of unions(); track union.id) {
                    @for (member of getOtherMembers(union); track member.id) {
                      <mat-list-item class="clickable" (click)="navigateToPerson(member.personId)">
                        <i matListItemIcon class="fa-solid" [ngClass]="[getSexIconClass(member.personSex), getSexClass(member.personSex)]" aria-hidden="true"></i>
                        <span matListItemTitle>{{ getSpouseDisplayName(member) }}</span>
                        <span matListItemLine>
                          {{ getUnionTypeLabel(union.type) }}
                          @if (union.startDate) {
                            - {{ formatDate(union.startDate) }}
                          }
                        </span>
                        <button mat-icon-button matListItemMeta (click)="removeUnion(union, $event)">
                          <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                        </button>
                      </mat-list-item>
                    }
                  }
                </mat-list>
              } @else {
                <p class="no-data">{{ 'personDetail.noData.spouses' | translate }}</p>
              }
            </div>

            <!-- Children Section -->
            <div class="family-section">
              <div class="section-header">
                <h3>{{ 'personDetail.sections.children' | translate }}</h3>
                <button mat-stroked-button (click)="addRelationship('child')">
                  <i class="fa-solid fa-plus" aria-hidden="true"></i> {{ 'personDetail.actions.addChild' | translate }}
                </button>
              </div>
              @if (children().length > 0) {
                <mat-list>
                  @for (child of children(); track child.id) {
                    <mat-list-item class="clickable" (click)="navigateToPerson(child.childId)">
                      <i matListItemIcon class="fa-solid" [ngClass]="[getSexIconClass(child.childSex), getSexClass(child.childSex)]" aria-hidden="true"></i>
                      <span matListItemTitle>{{ getChildDisplayName(child) }}</span>
                      <span matListItemLine>
                        {{ getRelationshipTypeLabel(child.relationshipType) }}
                        @if (child.isAdopted) { ({{ 'personDetail.relationshipTypes.adopted' | translate }}) }
                      </span>
                      <button mat-icon-button matListItemMeta (click)="removeChild(child, $event)">
                        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                      </button>
                    </mat-list-item>
                  }
                </mat-list>
              } @else {
                <p class="no-data">{{ 'personDetail.noData.children' | translate }}</p>
              }
            </div>
          </mat-card-content>
        </mat-card>
      </mat-tab>

      <!-- Media Tab -->
      <mat-tab [label]="'personDetail.tabs.media' | translate">
        <mat-card class="tab-content">
          <mat-card-content>
            <app-person-media [personId]="personId()!" />
          </mat-card-content>
        </mat-card>
      </mat-tab>
    </mat-tab-group>
  }
</div>

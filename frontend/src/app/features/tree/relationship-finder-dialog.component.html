<div class="relationship-finder">
  <!-- Header -->
  <div class="relationship-finder__header">
    <h2 class="relationship-finder__title">{{ 'relationship.findRelationship' | translate }}</h2>
    <button mat-icon-button (click)="onCancel()">
      <i class="fa-solid fa-xmark" aria-hidden="true"></i>
    </button>
  </div>

  <div class="relationship-finder__content">
    <!-- From Person (Fixed) -->
    <div class="relationship-finder__section">
      <label class="relationship-finder__label">{{ 'relationship.from' | translate }}</label>
      <div class="relationship-finder__person-chip">
        <div
          class="relationship-finder__avatar"
          [class.relationship-finder__avatar--male]="fromPersonSex === Sex.Male"
          [class.relationship-finder__avatar--female]="fromPersonSex === Sex.Female"
          [class.relationship-finder__avatar--has-image]="fromPersonAvatarUrl()">
          @if (fromPersonAvatarUrl()) {
            <img [src]="fromPersonAvatarUrl()" [alt]="fromPersonName" class="relationship-finder__avatar-img">
          } @else {
            {{ getInitials(fromPersonName) }}
          }
        </div>
        <span class="relationship-finder__person-name">{{ fromPersonName }}</span>
      </div>
    </div>

    <!-- Connection Arrow -->
    <div class="relationship-finder__arrow">
      <i class="fa-solid fa-rotate" aria-hidden="true"></i>
    </div>

    <!-- To Person (Searchable) -->
    <div class="relationship-finder__section">
      <label class="relationship-finder__label">{{ 'relationship.to' | translate }}</label>

      @if (selectedToPerson()) {
        <!-- Selected person chip with remove button -->
        <div class="relationship-finder__person-chip relationship-finder__person-chip--removable" (click)="clearToPerson()">
          <div
            class="relationship-finder__avatar"
            [class.relationship-finder__avatar--male]="selectedToPerson()!.sex === Sex.Male"
            [class.relationship-finder__avatar--female]="selectedToPerson()!.sex === Sex.Female">
            {{ getInitials(getPersonDisplayName(selectedToPerson())) }}
          </div>
          <span class="relationship-finder__person-name">{{ getPersonFullDisplayName(selectedToPerson()) }}</span>
          <i class="fa-solid fa-xmark relationship-finder__remove" aria-hidden="true"></i>
        </div>
      } @else {
        <!-- Search input -->
        <div class="relationship-finder__search">
          <div class="ft-search">
            <i class="fa-solid fa-magnifying-glass ft-search__icon" aria-hidden="true"></i>
            <input
              type="text"
              class="ft-search__input"
              [placeholder]="'people.searchPlaceholder' | translate"
              [(ngModel)]="searchQuery"
              (ngModelChange)="onSearchChange($event)"
              autocomplete="off"
              autofocus>
            @if (searchQuery) {
              <button class="ft-search__clear" (click)="clearSearch()">
                <i class="fa-solid fa-xmark" aria-hidden="true"></i>
              </button>
            }
          </div>
        </div>

        <!-- Search Results -->
        <div class="relationship-finder__results">
          @if (searching()) {
            <div class="relationship-finder__loading">
              <mat-spinner diameter="24"></mat-spinner>
              <span>{{ 'common.searching' | translate }}</span>
            </div>
          } @else if (searchResults().length > 0) {
            <div class="relationship-finder__list">
              @for (person of searchResults(); track person.id) {
                <div
                  class="relationship-finder__result-item"
                  [class.disabled]="person.id === data.fromPerson.id"
                  matRipple
                  (click)="selectToPerson(person)">
                  <div
                    class="relationship-finder__avatar relationship-finder__avatar--small"
                    [class.relationship-finder__avatar--male]="person.sex === Sex.Male"
                    [class.relationship-finder__avatar--female]="person.sex === Sex.Female">
                    {{ getInitials(getPersonDisplayName(person)) }}
                  </div>
                  <div class="relationship-finder__result-info">
                    <div class="relationship-finder__result-name">{{ getPersonFullDisplayName(person) }}</div>
                    <div class="relationship-finder__result-meta">
                      @if (person.birthDate) {
                        <span>{{ formatYear(person.birthDate) }}</span>
                      }
                      @if (person.birthDate && person.deathDate) {
                        <span>-</span>
                      }
                      @if (person.deathDate) {
                        <span>{{ formatYear(person.deathDate) }}</span>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          } @else if (searchQuery && !searching()) {
            <div class="relationship-finder__empty">
              <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
              <span>{{ 'common.noResults' | translate }}</span>
            </div>
          } @else {
            <div class="relationship-finder__hint">
              <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
              <span>{{ 'relationship.searchHint' | translate }}</span>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Footer -->
  <div class="relationship-finder__footer">
    <button mat-button (click)="onCancel()">
      {{ 'common.cancel' | translate }}
    </button>
    <button
      mat-flat-button
      color="primary"
      [disabled]="!selectedToPerson() || findingPath()"
      (click)="findRelationship()">
      @if (findingPath()) {
        <mat-spinner diameter="20"></mat-spinner>
      } @else {
        <i class="fa-solid fa-link" aria-hidden="true"></i>
        {{ 'relationship.showLink' | translate }}
      }
    </button>
  </div>
</div>

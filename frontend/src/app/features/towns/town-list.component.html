<div class="towns-page">
  <!-- Decorative Header Banner -->
  <div class="towns-page__banner">
    <div class="towns-page__banner-pattern"></div>
    <div class="towns-page__banner-content">
      <div class="towns-page__banner-icon">
        <mat-icon>location_city</mat-icon>
      </div>
      <h1 class="towns-page__title">{{ i18n.t('towns.title') }}</h1>
      <p class="towns-page__subtitle">{{ i18n.t('towns.subtitle') || 'Explore towns and villages' }}</p>
    </div>
  </div>

  <div class="towns-page__container">
    <!-- Action Buttons -->
    @if (isSuperAdmin()) {
      <div class="towns-page__actions">
        <button mat-stroked-button color="primary" (click)="showImportModal = true" class="towns-page__action-btn">
          <mat-icon>upload_file</mat-icon>
          <span>{{ i18n.t('towns.import') }}</span>
        </button>
        <button mat-raised-button color="primary" (click)="showCreateModal = true" class="towns-page__action-btn">
          <mat-icon>add_location_alt</mat-icon>
          <span>{{ i18n.t('towns.create') }}</span>
        </button>
      </div>
    }

    <!-- Search & Filters -->
    <div class="towns-page__filters">
      <mat-form-field appearance="outline" class="towns-page__search">
        <mat-label>{{ i18n.t('towns.searchPlaceholder') }}</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput [(ngModel)]="searchQuery" (ngModelChange)="onSearchChange()">
        @if (searchQuery) {
          <button matSuffix mat-icon-button (click)="searchQuery = ''; onSearchChange()">
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="towns-page__country-filter">
        <mat-label>{{ i18n.t('towns.country') }}</mat-label>
        <mat-icon matPrefix>public</mat-icon>
        <mat-select [(ngModel)]="selectedCountry" (ngModelChange)="loadTowns()">
          <mat-option value="">{{ i18n.t('towns.allCountries') }}</mat-option>
          @for (country of countries(); track country) {
            <mat-option [value]="country">{{ country }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Loading -->
    @if (loading()) {
      <div class="towns-page__loading">
        <mat-spinner diameter="48" color="primary"></mat-spinner>
        <span>{{ i18n.t('common.loading') }}</span>
      </div>
    }

    <!-- Error -->
    @if (error()) {
      <div class="towns-page__error">
        <mat-icon>error_outline</mat-icon>
        <span>{{ error() }}</span>
        <button mat-button color="primary" (click)="loadTowns()">
          <mat-icon>refresh</mat-icon>
          {{ i18n.t('common.retry') }}
        </button>
      </div>
    }

    <!-- Town Grid -->
    @if (!loading() && towns().length > 0) {
      <div class="towns-page__grid">
        @for (town of towns(); track town.id) {
          <a [routerLink]="['/towns', town.id]" class="town-card">
            <!-- Card Header with Nubian Pattern -->
            <div class="town-card__header">
              <div class="town-card__pattern"></div>
              <div class="town-card__icon">
                <mat-icon>mosque</mat-icon>
              </div>
            </div>

            <!-- Card Content -->
            <div class="town-card__content">
              <h3 class="town-card__name">{{ getTownName(town) }}</h3>

              @if (town.country) {
                <div class="town-card__location">
                  <mat-icon>place</mat-icon>
                  <span>{{ town.country }}</span>
                </div>
              }

              <div class="town-card__stats">
                <div class="town-card__stat">
                  <mat-icon>account_tree</mat-icon>
                  <span>{{ town.treeCount }} {{ i18n.t('towns.trees') }}</span>
                </div>
                <div class="town-card__stat town-card__stat--date">
                  <mat-icon>calendar_today</mat-icon>
                  <span>{{ formatDate(town.createdAt) }}</span>
                </div>
              </div>
            </div>

            <!-- Hover Arrow -->
            <div class="town-card__arrow">
              <mat-icon>arrow_forward</mat-icon>
            </div>
          </a>
        }
      </div>

      <!-- Pagination -->
      @if (totalPages() > 1) {
        <div class="towns-page__pagination">
          <button mat-icon-button
                  [disabled]="currentPage() === 1"
                  (click)="goToPage(currentPage() - 1)"
                  [matTooltip]="i18n.t('common.previous')">
            <mat-icon>chevron_left</mat-icon>
          </button>

          <div class="towns-page__page-info">
            <span class="towns-page__page-current">{{ currentPage() }}</span>
            <span class="towns-page__page-separator">/</span>
            <span class="towns-page__page-total">{{ totalPages() }}</span>
          </div>

          <button mat-icon-button
                  [disabled]="currentPage() === totalPages()"
                  (click)="goToPage(currentPage() + 1)"
                  [matTooltip]="i18n.t('common.next')">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      }
    }

    <!-- Empty State -->
    @if (!loading() && towns().length === 0) {
      <div class="towns-page__empty">
        <div class="towns-page__empty-icon">
          <mat-icon>location_off</mat-icon>
        </div>
        <h3>{{ i18n.t('towns.noTowns') }}</h3>
        <p>{{ i18n.t('towns.noTownsDesc') }}</p>
        @if (isSuperAdmin()) {
          <button mat-raised-button color="primary" (click)="showCreateModal = true">
            <mat-icon>add_location_alt</mat-icon>
            {{ i18n.t('towns.createFirst') }}
          </button>
        }
      </div>
    }
  </div>

  <!-- Create Modal -->
  @if (showCreateModal) {
    <div class="modal-backdrop" (click)="showCreateModal = false">
      <div class="modal-container" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <mat-icon class="modal-header__icon">add_location_alt</mat-icon>
          <h2>{{ i18n.t('towns.createTitle') }}</h2>
          <button mat-icon-button (click)="showCreateModal = false" class="modal-close">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <form (ngSubmit)="createTown()" class="modal-content">
          <mat-form-field appearance="outline" class="modal-field">
            <mat-label>{{ i18n.t('towns.name') }} *</mat-label>
            <mat-icon matPrefix>badge</mat-icon>
            <input matInput [(ngModel)]="newTown.name" name="name" required>
          </mat-form-field>

          <mat-form-field appearance="outline" class="modal-field">
            <mat-label>{{ i18n.t('towns.nameEn') }}</mat-label>
            <mat-icon matPrefix>translate</mat-icon>
            <input matInput [(ngModel)]="newTown.nameEn" name="nameEn">
            <mat-hint>English</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="modal-field">
            <mat-label>{{ i18n.t('towns.nameAr') }}</mat-label>
            <mat-icon matPrefix>translate</mat-icon>
            <input matInput [(ngModel)]="newTown.nameAr" name="nameAr" dir="rtl">
            <mat-hint>العربية</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="modal-field">
            <mat-label>{{ i18n.t('towns.nameLocal') }}</mat-label>
            <mat-icon matPrefix>language</mat-icon>
            <input matInput [(ngModel)]="newTown.nameLocal" name="nameLocal">
            <mat-hint>Nobiin</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="modal-field">
            <mat-label>{{ i18n.t('towns.country') }}</mat-label>
            <mat-icon matPrefix>public</mat-icon>
            <input matInput [(ngModel)]="newTown.country" name="country">
          </mat-form-field>

          <mat-form-field appearance="outline" class="modal-field">
            <mat-label>{{ i18n.t('towns.description') }}</mat-label>
            <mat-icon matPrefix>description</mat-icon>
            <textarea matInput [(ngModel)]="newTown.description" name="description" rows="3"></textarea>
          </mat-form-field>

          @if (createError()) {
            <div class="modal-error">
              <mat-icon>error</mat-icon>
              <span>{{ createError() }}</span>
            </div>
          }

          <div class="modal-actions">
            <button mat-stroked-button type="button" (click)="showCreateModal = false">
              {{ i18n.t('common.cancel') }}
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="creating()">
              @if (creating()) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <mat-icon>check</mat-icon>
              }
              {{ creating() ? i18n.t('common.creating') : i18n.t('common.create') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Import Modal -->
  @if (showImportModal) {
    <div class="modal-backdrop" (click)="showImportModal = false">
      <div class="modal-container modal-container--lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <mat-icon class="modal-header__icon">upload_file</mat-icon>
          <h2>{{ i18n.t('towns.importTitle') }}</h2>
          <button mat-icon-button (click)="closeImportModal()" class="modal-close">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="modal-content">
          <div class="import-info">
            <mat-icon>info</mat-icon>
            <div>
              <p>{{ i18n.t('towns.importDesc') }}</p>
              <code>name,name_en,name_ar,name_local,country</code>
            </div>
          </div>

          <div class="import-dropzone"
               [class.import-dropzone--active]="isDragging"
               [class.import-dropzone--has-file]="selectedFile"
               (dragover)="onDragOver($event)"
               (dragleave)="isDragging = false"
               (drop)="onDrop($event)">
            @if (selectedFile) {
              <mat-icon class="import-dropzone__icon import-dropzone__icon--success">check_circle</mat-icon>
              <span class="import-dropzone__filename">{{ selectedFile.name }}</span>
              <button mat-icon-button color="warn" (click)="selectedFile = null">
                <mat-icon>delete</mat-icon>
              </button>
            } @else {
              <mat-icon class="import-dropzone__icon">cloud_upload</mat-icon>
              <p class="import-dropzone__text">{{ i18n.t('towns.dropFile') }}</p>
              <label class="import-dropzone__browse">
                {{ i18n.t('towns.browseFile') }}
                <input type="file" accept=".csv" (change)="onFileSelected($event)">
              </label>
            }
          </div>

          @if (importResult()) {
            <div class="import-result" [class.import-result--success]="importResult()!.errors === 0">
              <mat-icon>{{ importResult()!.errors === 0 ? 'check_circle' : 'warning' }}</mat-icon>
              <div class="import-result__details">
                <p class="import-result__title">{{ i18n.t('towns.importResult') }}</p>
                <ul>
                  <li><mat-icon>add_circle</mat-icon> {{ i18n.t('towns.importCreated', { count: importResult()!.created }) }}</li>
                  <li><mat-icon>skip_next</mat-icon> {{ i18n.t('towns.importSkipped', { count: importResult()!.skipped }) }}</li>
                  @if (importResult()!.errors > 0) {
                    <li class="import-result__error"><mat-icon>error</mat-icon> {{ i18n.t('towns.importErrors', { count: importResult()!.errors }) }}</li>
                  }
                </ul>
              </div>
            </div>
          }

          @if (importError()) {
            <div class="modal-error">
              <mat-icon>error</mat-icon>
              <span>{{ importError() }}</span>
            </div>
          }

          <div class="modal-actions">
            <button mat-stroked-button (click)="closeImportModal()">
              {{ i18n.t('common.close') }}
            </button>
            <button mat-raised-button color="primary" [disabled]="!selectedFile || importing()" (click)="importTowns()">
              @if (importing()) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                <mat-icon>upload</mat-icon>
              }
              {{ importing() ? i18n.t('common.importing') : i18n.t('towns.import') }}
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>

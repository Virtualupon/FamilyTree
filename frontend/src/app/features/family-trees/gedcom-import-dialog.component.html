<div class="modal-overlay" (click)="onOverlayClick($event)">
  <div class="modal-container" [class.rtl]="i18n.isRtl()">
    <!-- Header -->
    <div class="modal-header">
      <h2>{{ t('gedcom.title') }}</h2>
      <button class="close-btn" (click)="close.emit()" [attr.aria-label]="t('common.close')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step" [class.active]="step() === 'upload'" [class.completed]="stepIndex() > 0">
        <span class="step-number">1</span>
        <span class="step-label">{{ t('gedcom.steps.upload') }}</span>
      </div>
      <div class="step-line" [class.completed]="stepIndex() > 0"></div>
      <div class="step" [class.active]="step() === 'preview'" [class.completed]="stepIndex() > 1">
        <span class="step-number">2</span>
        <span class="step-label">{{ t('gedcom.steps.preview') }}</span>
      </div>
      <div class="step-line" [class.completed]="stepIndex() > 1"></div>
      <div class="step" [class.active]="step() === 'options'" [class.completed]="stepIndex() > 2">
        <span class="step-number">3</span>
        <span class="step-label">{{ t('gedcom.steps.options') }}</span>
      </div>
      <div class="step-line" [class.completed]="stepIndex() > 2"></div>
      <div class="step" [class.active]="step() === 'result'" [class.completed]="stepIndex() > 3">
        <span class="step-number">4</span>
        <span class="step-label">{{ t('gedcom.steps.result') }}</span>
      </div>
    </div>

    <!-- Content -->
    <div class="modal-content">
      <!-- Upload Step -->
      @if (step() === 'upload') {
        <div class="upload-area"
             [class.drag-over]="isDragOver()"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (drop)="onDrop($event)"
             (click)="fileInput.click()">
          <input #fileInput type="file" accept=".ged" (change)="onFileSelected($event)" hidden>
          <div class="upload-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
          </div>
          <p class="upload-text">{{ t('gedcom.upload.dragDrop') }}</p>
          <p class="upload-subtext">{{ t('gedcom.upload.or') }}</p>
          <button class="browse-btn">{{ t('gedcom.upload.browse') }}</button>
          <p class="upload-hint">{{ t('gedcom.upload.hint') }}</p>
        </div>

        @if (uploadError()) {
          <div class="error-message">{{ uploadError() }}</div>
        }
      }

      <!-- Preview Step -->
      @if (step() === 'preview') {
        @if (loading()) {
          <div class="loading-state">
            <div class="spinner"></div>
            <p>{{ t('gedcom.preview.analyzing') }}</p>
          </div>
        } @else if (preview()) {
          <div class="preview-content">
            <!-- Sub-tab navigation -->
            <div class="preview-tabs">
              <button class="tab-btn" [class.active]="previewTab() === 'summary'" (click)="setPreviewTab('summary')">
                {{ t('gedcom.preview.tabSummary') }}
              </button>
              <button class="tab-btn" [class.active]="previewTab() === 'families'" (click)="setPreviewTab('families')">
                {{ t('gedcom.preview.tabFamilies') }}
                <span class="tab-count">{{ preview()!.familyGroups.length }}</span>
              </button>
              <button class="tab-btn" [class.active]="previewTab() === 'individuals'" (click)="setPreviewTab('individuals')">
                {{ t('gedcom.preview.tabIndividuals') }}
                <span class="tab-count">{{ preview()!.individualCount }}</span>
              </button>
              <button class="tab-btn" [class.active]="previewTab() === 'issues'" (click)="setPreviewTab('issues')">
                {{ t('gedcom.preview.tabIssues') }}
                @if (preview()!.dataQualityIssues.length > 0) {
                  <span class="tab-count warning">{{ preview()!.dataQualityIssues.length }}</span>
                }
              </button>
            </div>

            <!-- Tab 1: Summary -->
            @if (previewTab() === 'summary') {
              <div class="tab-content">
                <div class="preview-stats">
                  <div class="stat-card">
                    <div class="stat-value">{{ preview()!.individualCount }}</div>
                    <div class="stat-label">{{ t('gedcom.preview.individuals') }}</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">{{ preview()!.familyCount }}</div>
                    <div class="stat-label">{{ t('gedcom.preview.families') }}</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">{{ formatFileSize(preview()!.fileSize) }}</div>
                    <div class="stat-label">{{ t('gedcom.preview.fileSize') }}</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">{{ preview()!.encoding }}</div>
                    <div class="stat-label">{{ t('gedcom.preview.encoding') }}</div>
                  </div>
                </div>

                <!-- Linkage Analysis -->
                <div class="linkage-section">
                  <h4>{{ t('gedcom.preview.linkageAnalysis') }}</h4>
                  <div class="linkage-method" [style.border-left-color]="getLinkingMethodColor()">
                    <span class="method-badge" [style.background]="getLinkingMethodColor()">
                      {{ preview()!.linkageStatistics.linkingMethod }}
                    </span>
                    <p>{{ preview()!.linkageStatistics.linkingMethodDescription }}</p>
                  </div>
                  <div class="linkage-stats">
                    <div class="linkage-stat">
                      <span class="ls-value">{{ preview()!.linkageStatistics.individualsWithFAMC }}</span>
                      <span class="ls-label">{{ t('gedcom.preview.withFAMC') }}</span>
                    </div>
                    <div class="linkage-stat">
                      <span class="ls-value">{{ preview()!.linkageStatistics.individualsWithFAMS }}</span>
                      <span class="ls-label">{{ t('gedcom.preview.withFAMS') }}</span>
                    </div>
                    <div class="linkage-stat">
                      <span class="ls-value">{{ preview()!.linkageStatistics.individualsInFamilies }}</span>
                      <span class="ls-label">{{ t('gedcom.preview.inFamilies') }}</span>
                    </div>
                    <div class="linkage-stat">
                      <span class="ls-value orphaned">{{ preview()!.linkageStatistics.orphanedCount }}</span>
                      <span class="ls-label">{{ t('gedcom.preview.orphaned') }}</span>
                    </div>
                  </div>
                </div>

                @if (preview()!.warningCount > 0) {
                  <div class="warnings-section">
                    <h4>{{ t('gedcom.preview.warnings') }} ({{ preview()!.warningCount }})</h4>
                    <ul>
                      @for (warning of preview()!.warnings; track warning) {
                        <li>{{ warning }}</li>
                      }
                    </ul>
                  </div>
                }
              </div>
            }

            <!-- Tab 2: Family Groups -->
            @if (previewTab() === 'families') {
              <div class="tab-content">
                @if (preview()!.familyGroupsTruncated) {
                  <div class="info-banner">
                    {{ t('gedcom.preview.familiesTruncated', { count: preview()!.familyGroups.length }) }}
                  </div>
                }

                <div class="family-accordion">
                  @for (group of paginatedFamilies(); track trackByFamilyId($index, group)) {
                    <div class="family-panel" [class.expanded]="isFamilyExpanded(group.familyId)">
                      <button class="family-header" (click)="toggleFamily(group.familyId)">
                        <span class="family-title">{{ getFamilyHeaderText(group) }}</span>
                        <span class="family-meta">
                          {{ group.children.length }} {{ t('gedcom.preview.children') }}
                          @if (group.issues.length > 0) {
                            <span class="issue-badge">{{ group.issues.length }}</span>
                          }
                        </span>
                        <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="6 9 12 15 18 9"/>
                        </svg>
                      </button>
                      @if (isFamilyExpanded(group.familyId)) {
                        <div class="family-detail">
                          <div class="family-members">
                            @if (group.husband) {
                              <div class="member-row">
                                <span class="member-role">{{ t('gedcom.preview.husband') }}</span>
                                <span class="member-name">{{ group.husband.fullName || group.husband.id }}</span>
                                @if (group.husband.birthDate) {
                                  <span class="member-dates">{{ group.husband.birthDate }}</span>
                                }
                              </div>
                            }
                            @if (group.wife) {
                              <div class="member-row">
                                <span class="member-role">{{ t('gedcom.preview.wife') }}</span>
                                <span class="member-name">{{ group.wife.fullName || group.wife.id }}</span>
                                @if (group.wife.birthDate) {
                                  <span class="member-dates">{{ group.wife.birthDate }}</span>
                                }
                              </div>
                            }
                            @if (group.marriageDate || group.marriagePlace) {
                              <div class="member-row event-row">
                                <span class="member-role">{{ t('gedcom.preview.marriage') }}</span>
                                <span class="member-name">
                                  {{ group.marriageDate || '' }}
                                  @if (group.marriagePlace) { — {{ group.marriagePlace }} }
                                </span>
                              </div>
                            }
                            @if (group.divorceDate) {
                              <div class="member-row event-row">
                                <span class="member-role">{{ t('gedcom.preview.divorce') }}</span>
                                <span class="member-name">{{ group.divorceDate }}</span>
                              </div>
                            }
                          </div>
                          @if (group.children.length > 0) {
                            <div class="children-list">
                              <h5>{{ t('gedcom.preview.children') }}</h5>
                              @for (child of group.children; track trackById($index, child)) {
                                <div class="child-row">
                                  <span class="child-name">{{ child.fullName || child.id }}</span>
                                  <span class="child-meta">
                                    @if (child.sex) { {{ child.sex }} }
                                    @if (child.birthDate) { — {{ child.birthDate }} }
                                  </span>
                                </div>
                              }
                            </div>
                          }
                          @if (group.issues.length > 0) {
                            <div class="family-issues">
                              @for (issue of group.issues; track issue) {
                                <div class="family-issue-item">{{ issue }}</div>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>

                <!-- Family pagination -->
                @if (totalFamilyPages() > 1) {
                  <div class="pagination">
                    <button class="page-btn" [disabled]="familyPage() === 1" (click)="setFamilyPage(familyPage() - 1)">
                      {{ t('common.previous') }}
                    </button>
                    <span class="page-info">{{ familyPage() }} / {{ totalFamilyPages() }}</span>
                    <button class="page-btn" [disabled]="familyPage() === totalFamilyPages()" (click)="setFamilyPage(familyPage() + 1)">
                      {{ t('common.next') }}
                    </button>
                  </div>
                }
              </div>
            }

            <!-- Tab 3: All Individuals -->
            @if (previewTab() === 'individuals') {
              <div class="tab-content">
                @if (preview()!.allIndividualsTruncated) {
                  <div class="info-banner">
                    {{ t('gedcom.preview.individualsTruncated', { shown: preview()!.allIndividuals.length, total: preview()!.individualCount }) }}
                  </div>
                }

                <!-- Search and filters -->
                <div class="individual-controls">
                  <input
                    type="text"
                    class="search-input"
                    [placeholder]="t('gedcom.preview.searchPlaceholder')"
                    (input)="onSearchInput($event)"
                  >
                  <div class="filter-chips">
                    <button class="chip" [class.active]="individualFilter() === 'all'" (click)="setIndividualFilter('all')">
                      {{ t('gedcom.preview.filterAll') }}
                    </button>
                    <button class="chip" [class.active]="individualFilter() === 'orphaned'" (click)="setIndividualFilter('orphaned')">
                      {{ t('gedcom.preview.filterOrphaned') }}
                      <span class="chip-count">{{ preview()!.linkageStatistics.orphanedCount }}</span>
                    </button>
                    <button class="chip" [class.active]="individualFilter() === 'noFAMC'" (click)="setIndividualFilter('noFAMC')">
                      {{ t('gedcom.preview.filterNoFAMC') }}
                    </button>
                    <button class="chip" [class.active]="individualFilter() === 'noFAMS'" (click)="setIndividualFilter('noFAMS')">
                      {{ t('gedcom.preview.filterNoFAMS') }}
                    </button>
                  </div>
                </div>

                <div class="individuals-table-wrap">
                  <table class="individuals-table">
                    <thead>
                      <tr>
                        <th>{{ t('gedcom.preview.colId') }}</th>
                        <th>{{ t('gedcom.preview.name') }}</th>
                        <th>{{ t('gedcom.preview.sex') }}</th>
                        <th>{{ t('gedcom.preview.birth') }}</th>
                        <th>{{ t('gedcom.preview.death') }}</th>
                        <th>{{ t('gedcom.preview.colLinks') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (person of paginatedIndividuals(); track trackById($index, person)) {
                        <tr [class.orphaned-row]="person.isOrphaned">
                          <td class="id-cell">{{ person.id }}</td>
                          <td>{{ person.fullName || '—' }}</td>
                          <td>{{ person.sex || '—' }}</td>
                          <td>{{ person.birthDate || '—' }}</td>
                          <td>{{ person.deathDate || '—' }}</td>
                          <td class="links-cell">
                            @if (person.hasFAMC) { <span class="link-tag famc">FAMC</span> }
                            @if (person.hasFAMS) { <span class="link-tag fams">FAMS</span> }
                            @if (person.isOrphaned) { <span class="link-tag orphan">{{ t('gedcom.preview.orphaned') }}</span> }
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>

                <div class="table-footer">
                  <span class="result-count">
                    {{ t('gedcom.preview.showingCount', { count: filteredIndividuals().length }) }}
                  </span>
                  @if (totalIndividualPages() > 1) {
                    <div class="pagination">
                      <button class="page-btn" [disabled]="individualPage() === 1" (click)="setIndividualPage(individualPage() - 1)">
                        {{ t('common.previous') }}
                      </button>
                      <span class="page-info">{{ individualPage() }} / {{ totalIndividualPages() }}</span>
                      <button class="page-btn" [disabled]="individualPage() === totalIndividualPages()" (click)="setIndividualPage(individualPage() + 1)">
                        {{ t('common.next') }}
                      </button>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Tab 4: Issues -->
            @if (previewTab() === 'issues') {
              <div class="tab-content">
                @if (preview()!.dataQualityIssues.length === 0) {
                  <div class="empty-state">
                    <p>{{ t('gedcom.preview.noIssues') }}</p>
                  </div>
                } @else {
                  <!-- Errors -->
                  @if (errorIssues().length > 0) {
                    <div class="issues-group error">
                      <h4>{{ t('gedcom.preview.issueErrors') }} ({{ errorIssues().length }})</h4>
                      @for (issue of errorIssues(); track issue.message) {
                        <div class="issue-card">
                          <span class="issue-severity error">{{ issue.severity }}</span>
                          <span class="issue-category">{{ issue.category }}</span>
                          <p class="issue-message">{{ issue.message }}</p>
                          @if (issue.affectedIds.length > 0) {
                            <div class="affected-ids">
                              @for (id of issue.affectedIds; track id) {
                                <span class="affected-id">{{ id }}</span>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }

                  <!-- Warnings -->
                  @if (warningIssues().length > 0) {
                    <div class="issues-group warning">
                      <h4>{{ t('gedcom.preview.issueWarnings') }} ({{ warningIssues().length }})</h4>
                      @for (issue of warningIssues(); track issue.message) {
                        <div class="issue-card">
                          <span class="issue-severity warning">{{ issue.severity }}</span>
                          <span class="issue-category">{{ issue.category }}</span>
                          <p class="issue-message">{{ issue.message }}</p>
                          @if (issue.affectedIds.length > 0) {
                            <div class="affected-ids">
                              @for (id of issue.affectedIds; track id) {
                                <span class="affected-id">{{ id }}</span>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }

                  <!-- Info -->
                  @if (infoIssues().length > 0) {
                    <div class="issues-group info">
                      <h4>{{ t('gedcom.preview.issueInfo') }} ({{ infoIssues().length }})</h4>
                      @for (issue of infoIssues(); track issue.message) {
                        <div class="issue-card">
                          <span class="issue-severity info">{{ issue.severity }}</span>
                          <span class="issue-category">{{ issue.category }}</span>
                          <p class="issue-message">{{ issue.message }}</p>
                          @if (issue.affectedIds.length > 0) {
                            <div class="affected-ids">
                              @for (id of issue.affectedIds; track id) {
                                <span class="affected-id">{{ id }}</span>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                }
              </div>
            }
          </div>
        }
      }

      <!-- Options Step -->
      @if (step() === 'options') {
        <div class="options-form">
          <div class="form-group">
            <label for="townId">{{ t('gedcom.options.town') }} <span class="required">*</span></label>
            <select
              id="townId"
              [(ngModel)]="selectedTownId"
              [class.invalid]="!selectedTownId && townTouched()"
              (blur)="townTouched.set(true)"
              (change)="onTownChange()"
            >
              <option value="">{{ t('gedcom.options.selectTown') }}</option>
              @for (town of availableTowns(); track town.id) {
                <option [value]="town.id">{{ getLocalizedTownName(town) }}</option>
              }
            </select>
            @if (!selectedTownId && townTouched()) {
              <span class="field-error">{{ t('gedcom.options.townRequired') }}</span>
            }
          </div>

          <div class="form-group">
            <label for="treeId">{{ t('gedcom.options.treeName') }} <span class="required">*</span></label>
            <select
              id="treeId"
              [(ngModel)]="selectedTreeId"
              [disabled]="!selectedTownId || availableTrees().length === 0"
            >
              <option value="">{{ availableTrees().length === 0 ? 'No trees in selected town' : 'Select a tree' }}</option>
              @for (tree of availableTrees(); track tree.id) {
                <option [value]="tree.id">{{ tree.name }}</option>
              }
            </select>
            @if (selectedTownId && availableTrees().length === 0) {
              <span class="field-hint">No existing trees in this town. Create a new tree first.</span>
            }
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="importNotes">
              <span>{{ t('gedcom.options.importNotes') }}</span>
            </label>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="importOccupations">
              <span>{{ t('gedcom.options.importOccupations') }}</span>
            </label>
          </div>

          <div class="info-box">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="16" x2="12" y2="12"/>
              <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            <p>{{ t('gedcom.options.info') }}</p>
          </div>
        </div>
      }

      <!-- Importing Step -->
      @if (step() === 'importing') {
        <div class="loading-state">
          <div class="spinner large"></div>
          <p>{{ t('gedcom.importing.message') }}</p>
          <p class="loading-subtext">{{ t('gedcom.importing.patience') }}</p>
        </div>
      }

      <!-- Result Step -->
      @if (step() === 'result') {
        @if (result()) {
          <div class="result-content" [class.success]="result()!.success" [class.error]="!result()!.success">
            <div class="result-icon">
              @if (result()!.success) {
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
              } @else {
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" y1="9" x2="9" y2="15"/>
                  <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
              }
            </div>

            <h3>{{ result()!.success ? t('gedcom.result.success') : t('gedcom.result.failed') }}</h3>
            <p class="result-message">{{ result()!.message }}</p>

            @if (result()!.success) {
              <div class="result-stats">
                <div class="result-stat">
                  <span class="value">{{ result()!.individualsImported }}</span>
                  <span class="label">{{ t('gedcom.result.individuals') }}</span>
                </div>
                <div class="result-stat">
                  <span class="value">{{ result()!.familiesImported }}</span>
                  <span class="label">{{ t('gedcom.result.families') }}</span>
                </div>
                <div class="result-stat">
                  <span class="value">{{ result()!.relationshipsCreated }}</span>
                  <span class="label">{{ t('gedcom.result.relationships') }}</span>
                </div>
              </div>
            }

            @if (result()!.warnings.length > 0) {
              <div class="result-warnings">
                <h4>{{ t('gedcom.result.warnings') }}</h4>
                <ul>
                  @for (warning of result()!.warnings.slice(0, 5); track warning) {
                    <li>{{ warning }}</li>
                  }
                </ul>
                @if (result()!.warnings.length > 5) {
                  <p class="more-warnings">{{ t('gedcom.result.moreWarnings', { count: result()!.warnings.length - 5 }) }}</p>
                }
              </div>
            }

            @if (result()!.errors.length > 0) {
              <div class="result-errors">
                <h4>{{ t('gedcom.result.errors') }}</h4>
                <ul>
                  @for (error of result()!.errors.slice(0, 5); track error) {
                    <li>{{ error }}</li>
                  }
                </ul>
              </div>
            }
          </div>
        }
      }
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      @if (step() === 'upload') {
        <button class="btn secondary" (click)="close.emit()">{{ t('common.cancel') }}</button>
      } @else if (step() === 'preview' || step() === 'options') {
        <button class="btn secondary" (click)="previousStep()">{{ t('common.back') }}</button>
        <button class="btn primary" (click)="nextStep()" [disabled]="loading() || (step() === 'options' && (!selectedTownId || !selectedTreeId))">
          {{ step() === 'options' ? t('gedcom.import') : t('common.next') }}
        </button>
      } @else if (step() === 'result') {
        <button class="btn primary" (click)="imported.emit(); close.emit()">{{ t('common.done') }}</button>
      }
    </div>
  </div>
</div>

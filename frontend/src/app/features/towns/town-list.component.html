<div class="max-w-6xl mx-auto p-4 md:p-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
    <h1 class="text-2xl font-bold text-on-surface">{{ i18n.t('towns.title') }}</h1>
    @if (isSuperAdmin()) {
      <div class="flex gap-2">
        <button
          (click)="showImportModal = true"
          class="inline-flex items-center gap-2 px-4 py-2 border border-primary text-primary rounded-lg hover:bg-primary/5 transition-colors min-h-touch">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          {{ i18n.t('towns.import') }}
        </button>
        <button
          (click)="showCreateModal = true"
          class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors min-h-touch">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          {{ i18n.t('towns.create') }}
        </button>
      </div>
    }
  </div>

  <!-- Search & Filters -->
  <div class="flex flex-col sm:flex-row gap-4 mb-6">
    <div class="flex-1">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearchChange()"
        class="w-full px-4 py-2 border border-border rounded-lg bg-surface text-on-surface focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
        [placeholder]="i18n.t('towns.searchPlaceholder')">
    </div>
    <select
      [(ngModel)]="selectedCountry"
      (ngModelChange)="loadTowns()"
      class="px-4 py-2 border border-border rounded-lg bg-surface text-on-surface focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
      <option value="">{{ i18n.t('towns.allCountries') }}</option>
      @for (country of countries(); track country) {
        <option [value]="country">{{ country }}</option>
      }
    </select>
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="flex justify-center py-12">
      <div class="w-12 h-12 border-4 border-border border-t-primary rounded-full animate-spin"></div>
    </div>
  }

  <!-- Error -->
  @if (error()) {
    <div class="bg-error/10 border border-error/30 text-error px-4 py-3 rounded-lg mb-4">
      {{ error() }}
    </div>
  }

  <!-- Town Grid -->
  @if (!loading() && towns().length > 0) {
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
      @for (town of towns(); track town.id) {
        <a
          [routerLink]="['/towns', town.id]"
          class="block bg-surface rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow">
          <!-- Cover -->
          <div class="h-24 bg-gradient-to-br from-primary to-primary-light flex items-center justify-center">
            <svg class="w-12 h-12 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
          </div>

          <!-- Content -->
          <div class="p-4">
            <h3 class="text-lg font-semibold text-on-surface mb-1">{{ getTownName(town) }}</h3>
            @if (town.country) {
              <p class="text-on-surface-variant text-sm mb-3">{{ town.country }}</p>
            }

            <div class="flex items-center justify-between text-sm text-on-surface-variant">
              <span>{{ town.treeCount }} {{ i18n.t('towns.trees') }}</span>
              <span class="text-xs">{{ formatDate(town.createdAt) }}</span>
            </div>
          </div>
        </a>
      }
    </div>

    <!-- Pagination -->
    @if (totalPages() > 1) {
      <div class="flex justify-center items-center gap-2 mt-6">
        <button
          (click)="goToPage(currentPage() - 1)"
          [disabled]="currentPage() === 1"
          class="px-4 py-2 border border-border rounded-lg bg-surface hover:bg-surface-variant disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
          {{ i18n.t('common.previous') }}
        </button>
        <span class="px-4 py-2 text-on-surface-variant">
          {{ i18n.t('common.pageOf', { page: currentPage(), total: totalPages() }) }}
        </span>
        <button
          (click)="goToPage(currentPage() + 1)"
          [disabled]="currentPage() === totalPages()"
          class="px-4 py-2 border border-border rounded-lg bg-surface hover:bg-surface-variant disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
          {{ i18n.t('common.next') }}
        </button>
      </div>
    }
  }

  <!-- Empty State -->
  @if (!loading() && towns().length === 0) {
    <div class="text-center py-12">
      <svg class="mx-auto h-16 w-16 text-on-surface-variant/50 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
      </svg>
      <h3 class="text-lg font-medium text-on-surface mb-2">{{ i18n.t('towns.noTowns') }}</h3>
      <p class="text-on-surface-variant mb-4">{{ i18n.t('towns.noTownsDesc') }}</p>
      @if (isSuperAdmin()) {
        <button
          (click)="showCreateModal = true"
          class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors">
          {{ i18n.t('towns.createFirst') }}
        </button>
      }
    </div>
  }

  <!-- Create Modal -->
  @if (showCreateModal) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" (click)="showCreateModal = false">
      <div class="bg-surface rounded-xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
        <div class="p-6">
          <h2 class="text-xl font-semibold text-on-surface mb-4">{{ i18n.t('towns.createTitle') }}</h2>

          <form (ngSubmit)="createTown()" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-on-surface mb-1">{{ i18n.t('towns.name') }} *</label>
              <input
                type="text"
                [(ngModel)]="newTown.name"
                name="name"
                required
                class="w-full px-3 py-2 border border-border rounded-lg bg-surface text-on-surface focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
            </div>

            <div>
              <label class="block text-sm font-medium text-on-surface mb-1">{{ i18n.t('towns.nameEn') }}</label>
              <input
                type="text"
                [(ngModel)]="newTown.nameEn"
                name="nameEn"
                class="w-full px-3 py-2 border border-border rounded-lg bg-surface text-on-surface focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
            </div>

            <div>
              <label class="block text-sm font-medium text-on-surface mb-1">{{ i18n.t('towns.nameAr') }}</label>
              <input
                type="text"
                [(ngModel)]="newTown.nameAr"
                name="nameAr"
                dir="rtl"
                class="w-full px-3 py-2 border border-border rounded-lg bg-surface text-on-surface focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
            </div>

            <div>
              <label class="block text-sm font-medium text-on-surface mb-1">{{ i18n.t('towns.nameLocal') }}</label>
              <input
                type="text"
                [(ngModel)]="newTown.nameLocal"
                name="nameLocal"
                class="w-full px-3 py-2 border border-border rounded-lg bg-surface text-on-surface focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
            </div>

            <div>
              <label class="block text-sm font-medium text-on-surface mb-1">{{ i18n.t('towns.country') }}</label>
              <input
                type="text"
                [(ngModel)]="newTown.country"
                name="country"
                class="w-full px-3 py-2 border border-border rounded-lg bg-surface text-on-surface focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
            </div>

            <div>
              <label class="block text-sm font-medium text-on-surface mb-1">{{ i18n.t('towns.description') }}</label>
              <textarea
                [(ngModel)]="newTown.description"
                name="description"
                rows="3"
                class="w-full px-3 py-2 border border-border rounded-lg bg-surface text-on-surface focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary resize-y"></textarea>
            </div>

            @if (createError()) {
              <div class="bg-error/10 border border-error/30 text-error px-3 py-2 rounded-lg text-sm">
                {{ createError() }}
              </div>
            }

            <div class="flex gap-3 pt-2">
              <button
                type="button"
                (click)="showCreateModal = false"
                class="flex-1 px-4 py-2 border border-border rounded-lg bg-surface hover:bg-surface-variant transition-colors">
                {{ i18n.t('common.cancel') }}
              </button>
              <button
                type="submit"
                [disabled]="creating()"
                class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark disabled:opacity-50 transition-colors">
                {{ creating() ? i18n.t('common.creating') : i18n.t('common.create') }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

  <!-- Import Modal -->
  @if (showImportModal) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" (click)="showImportModal = false">
      <div class="bg-surface rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
        <div class="p-6">
          <h2 class="text-xl font-semibold text-on-surface mb-4">{{ i18n.t('towns.importTitle') }}</h2>

          <div class="mb-4">
            <p class="text-sm text-on-surface-variant mb-2">{{ i18n.t('towns.importDesc') }}</p>
            <code class="block bg-surface-variant p-2 rounded text-xs font-mono">name,name_en,name_ar,name_local,country</code>
          </div>

          <div
            class="border-2 border-dashed rounded-lg p-8 text-center mb-4 transition-colors"
            [class.border-primary]="isDragging"
            [class.border-border]="!isDragging"
            [class.bg-green-50]="isDragging"
            (dragover)="onDragOver($event)"
            (dragleave)="isDragging = false"
            (drop)="onDrop($event)">
            @if (selectedFile) {
              <div class="flex items-center justify-center gap-2">
                <svg class="w-6 h-6 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="text-on-surface">{{ selectedFile.name }}</span>
                <button (click)="selectedFile = null" class="text-error hover:text-error/80 p-1">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            } @else {
              <svg class="mx-auto h-12 w-12 text-on-surface-variant/50 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
              </svg>
              <p class="text-on-surface-variant mb-2">{{ i18n.t('towns.dropFile') }}</p>
              <label class="cursor-pointer text-primary hover:text-primary-dark">
                {{ i18n.t('towns.browseFile') }}
                <input type="file" accept=".csv" (change)="onFileSelected($event)" class="hidden">
              </label>
            }
          </div>

          @if (importResult()) {
            <div class="mb-4 p-4 rounded-lg" [ngClass]="importResult()!.errors === 0 ? 'bg-green-100' : 'bg-yellow-100'">
              <p class="font-medium mb-2">{{ i18n.t('towns.importResult') }}</p>
              <ul class="text-sm space-y-1">
                <li>{{ i18n.t('towns.importCreated', { count: importResult()!.created }) }}</li>
                <li>{{ i18n.t('towns.importSkipped', { count: importResult()!.skipped }) }}</li>
                @if (importResult()!.errors > 0) {
                  <li class="text-error">{{ i18n.t('towns.importErrors', { count: importResult()!.errors }) }}</li>
                }
              </ul>
            </div>
          }

          @if (importError()) {
            <div class="bg-error/10 border border-error/30 text-error px-3 py-2 rounded-lg mb-4 text-sm">
              {{ importError() }}
            </div>
          }

          <div class="flex gap-3">
            <button
              type="button"
              (click)="closeImportModal()"
              class="flex-1 px-4 py-2 border border-border rounded-lg bg-surface hover:bg-surface-variant transition-colors">
              {{ i18n.t('common.close') }}
            </button>
            <button
              (click)="importTowns()"
              [disabled]="!selectedFile || importing()"
              class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark disabled:opacity-50 transition-colors">
              {{ importing() ? i18n.t('common.importing') : i18n.t('towns.import') }}
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>

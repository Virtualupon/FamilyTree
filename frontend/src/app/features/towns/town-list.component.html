<div class="town-list">
  <div class="town-list__header">
    <h1>{{ i18n.t('towns.title') }}</h1>
    @if (isSuperAdmin()) {
      <div class="town-list__actions">
        <button (click)="showImportModal = true" class="btn btn--outline">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          {{ i18n.t('towns.import') }}
        </button>
        <button (click)="showCreateModal = true" class="btn btn--primary">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          {{ i18n.t('towns.create') }}
        </button>
      </div>
    }
  </div>

  <!-- Search & Filters -->
  <div class="town-list__filters">
    <div class="search-input">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearchChange()"
        [placeholder]="i18n.t('towns.searchPlaceholder')">
    </div>
    <div class="country-select">
      <select [(ngModel)]="selectedCountry" (ngModelChange)="loadTowns()">
        <option value="">{{ i18n.t('towns.allCountries') }}</option>
        @for (country of countries(); track country) {
          <option [value]="country">{{ country }}</option>
        }
      </select>
    </div>
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="loading">
      <div class="spinner"></div>
    </div>
  }

  <!-- Error -->
  @if (error()) {
    <div class="error-message">
      {{ error() }}
    </div>
  }

  <!-- Town Grid -->
  @if (!loading() && towns().length > 0) {
    <div class="town-grid">
      @for (town of towns(); track town.id) {
        <a [routerLink]="['/towns', town.id]" class="town-card">
          <!-- Cover -->
          <div class="town-card__cover">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
            </svg>
          </div>

          <!-- Content -->
          <div class="town-card__content">
            <h3 class="town-card__name">{{ getTownName(town) }}</h3>
            @if (town.country) {
              <p class="town-card__country">{{ town.country }}</p>
            }

            <div class="town-card__meta">
              <span>{{ town.treeCount }} {{ i18n.t('towns.trees') }}</span>
              <span class="town-card__date">{{ formatDate(town.createdAt) }}</span>
            </div>
          </div>
        </a>
      }
    </div>

    <!-- Pagination -->
    @if (totalPages() > 1) {
      <div class="pagination">
        <button (click)="goToPage(currentPage() - 1)" [disabled]="currentPage() === 1">
          {{ i18n.t('common.previous') }}
        </button>
        <span>
          {{ i18n.t('common.pageOf', { page: currentPage(), total: totalPages() }) }}
        </span>
        <button (click)="goToPage(currentPage() + 1)" [disabled]="currentPage() === totalPages()">
          {{ i18n.t('common.next') }}
        </button>
      </div>
    }
  }

  <!-- Empty State -->
  @if (!loading() && towns().length === 0) {
    <div class="empty-state">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
      </svg>
      <h3>{{ i18n.t('towns.noTowns') }}</h3>
      <p>{{ i18n.t('towns.noTownsDesc') }}</p>
      @if (isSuperAdmin()) {
        <button (click)="showCreateModal = true" class="btn btn--primary">
          {{ i18n.t('towns.createFirst') }}
        </button>
      }
    </div>
  }

  <!-- Create Modal -->
  @if (showCreateModal) {
    <div class="modal-backdrop" (click)="showCreateModal = false">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal__content">
          <h2 class="modal__title">{{ i18n.t('towns.createTitle') }}</h2>

          <form (ngSubmit)="createTown()">
            <div class="form-group">
              <label class="form-label">{{ i18n.t('towns.name') }} *</label>
              <input
                type="text"
                [(ngModel)]="newTown.name"
                name="name"
                required
                class="form-input">
            </div>

            <div class="form-group">
              <label class="form-label">{{ i18n.t('towns.nameEn') }}</label>
              <input
                type="text"
                [(ngModel)]="newTown.nameEn"
                name="nameEn"
                class="form-input">
            </div>

            <div class="form-group">
              <label class="form-label">{{ i18n.t('towns.nameAr') }}</label>
              <input
                type="text"
                [(ngModel)]="newTown.nameAr"
                name="nameAr"
                dir="rtl"
                class="form-input">
            </div>

            <div class="form-group">
              <label class="form-label">{{ i18n.t('towns.nameLocal') }}</label>
              <input
                type="text"
                [(ngModel)]="newTown.nameLocal"
                name="nameLocal"
                class="form-input">
            </div>

            <div class="form-group">
              <label class="form-label">{{ i18n.t('towns.country') }}</label>
              <input
                type="text"
                [(ngModel)]="newTown.country"
                name="country"
                class="form-input">
            </div>

            <div class="form-group">
              <label class="form-label">{{ i18n.t('towns.description') }}</label>
              <textarea
                [(ngModel)]="newTown.description"
                name="description"
                rows="3"
                class="form-textarea"></textarea>
            </div>

            @if (createError()) {
              <div class="error-message">
                {{ createError() }}
              </div>
            }

            <div class="modal__actions">
              <button type="button" (click)="showCreateModal = false" class="btn btn--outline">
                {{ i18n.t('common.cancel') }}
              </button>
              <button type="submit" [disabled]="creating()" class="btn btn--primary">
                {{ creating() ? i18n.t('common.creating') : i18n.t('common.create') }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

  <!-- Import Modal -->
  @if (showImportModal) {
    <div class="modal-backdrop" (click)="showImportModal = false">
      <div class="modal modal--lg" (click)="$event.stopPropagation()">
        <div class="modal__content">
          <h2 class="modal__title">{{ i18n.t('towns.importTitle') }}</h2>

          <div class="import-info">
            <p>{{ i18n.t('towns.importDesc') }}</p>
            <code>name,name_en,name_ar,name_local,country</code>
          </div>

          <div
            class="dropzone"
            [class.dropzone--active]="isDragging"
            (dragover)="onDragOver($event)"
            (dragleave)="isDragging = false"
            (drop)="onDrop($event)">
            @if (selectedFile) {
              <div class="file-selected">
                <svg class="success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>{{ selectedFile.name }}</span>
                <button (click)="selectedFile = null" class="remove-btn">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            } @else {
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
              </svg>
              <p>{{ i18n.t('towns.dropFile') }}</p>
              <label class="file-input-label">
                {{ i18n.t('towns.browseFile') }}
                <input type="file" accept=".csv" (change)="onFileSelected($event)">
              </label>
            }
          </div>

          @if (importResult()) {
            <div class="import-result" [class.import-result--success]="importResult()!.errors === 0" [class.import-result--warning]="importResult()!.errors > 0">
              <p>{{ i18n.t('towns.importResult') }}</p>
              <ul>
                <li>{{ i18n.t('towns.importCreated', { count: importResult()!.created }) }}</li>
                <li>{{ i18n.t('towns.importSkipped', { count: importResult()!.skipped }) }}</li>
                @if (importResult()!.errors > 0) {
                  <li class="error-text">{{ i18n.t('towns.importErrors', { count: importResult()!.errors }) }}</li>
                }
              </ul>
            </div>
          }

          @if (importError()) {
            <div class="error-message">
              {{ importError() }}
            </div>
          }

          <div class="modal__actions">
            <button type="button" (click)="closeImportModal()" class="btn btn--outline">
              {{ i18n.t('common.close') }}
            </button>
            <button
              (click)="importTowns()"
              [disabled]="!selectedFile || importing()"
              class="btn btn--primary">
              {{ importing() ? i18n.t('common.importing') : i18n.t('towns.import') }}
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>

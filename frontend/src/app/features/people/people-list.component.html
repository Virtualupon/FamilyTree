<div class="ft-page people-page">
  <!-- Context Breadcrumb -->
  @if (currentTownName() || currentTreeName()) {
    <div class="people-page__context">
      @if (currentTownName()) {
        <span class="people-page__context-item">
          <i class="fa-solid fa-city" aria-hidden="true"></i>
          {{ currentTownName() }}
        </span>
      }
      @if (currentTownName() && currentTreeName()) {
        <i class="fa-solid fa-chevron-right people-page__context-sep" aria-hidden="true"></i>
      }
      @if (currentTreeName()) {
        <span class="people-page__context-item">
          <i class="fa-solid fa-sitemap" aria-hidden="true"></i>
          {{ currentTreeName() }}
        </span>
      }
    </div>
  }

  <!-- Header -->
  <header class="people-page__header">
    <div class="people-page__title-section">
      <h1 class="ft-page__title">{{ 'people.title' | translate }}</h1>
      @if (totalCount() > 0) {
        <span class="people-page__count">{{ 'people.totalCount' | translate: { count: totalCount() } }}</span>
      }
      @if (searchDuration() > 0) {
        <span class="people-page__duration">({{ searchDuration() }}ms)</span>
      }
    </div>

    <button
      mat-flat-button
      color="primary"
      class="people-page__add-btn d-mobile-none"
      (click)="openPersonForm()">
      <i class="fa-solid fa-plus" aria-hidden="true"></i>
      {{ 'people.addPerson' | translate }}
    </button>
  </header>

  <!-- Tree Context & Founding Ancestors Hero -->
  @if (currentTreeName()) {
    <div class="ancestors-hero"
         [class.ancestors-hero--collapsed]="heroCollapsed()"
         [class.ancestors-hero--no-ancestors]="rootPersons().length === 0 && !loadingAncestors()">

      <!-- Hero Header — always visible -->
      <div class="ancestors-hero__header" (click)="rootPersons().length > 0 ? toggleHero() : null"
           [class.ancestors-hero__header--clickable]="rootPersons().length > 0">
        <div class="ancestors-hero__title-row">
          <div class="ancestors-hero__tree-icon">
            <i class="fa-solid fa-sitemap" aria-hidden="true"></i>
          </div>
          <div class="ancestors-hero__title-text">
            <h2 class="ancestors-hero__tree-name">{{ currentTreeName() }}</h2>
            <div class="ancestors-hero__meta">
              @if (currentTownName()) {
                <span class="ancestors-hero__town">
                  <i class="fa-solid fa-city" aria-hidden="true"></i>
                  {{ currentTownName() }}
                </span>
              }
              @if (rootPersons().length > 0) {
                <span class="ancestors-hero__ancestor-count">
                  <i class="fa-solid fa-crown" aria-hidden="true"></i>
                  {{ 'people.ancestors.foundingAncestors' | translate }} · {{ rootPersons().length }}
                </span>
              }
              @if (loadingAncestors()) {
                <span class="ancestors-hero__loading-hint">
                  <i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i>
                </span>
              }
            </div>
          </div>
          <button class="ancestors-hero__tree-btn" (click)="viewTree()">
            <i class="fa-solid fa-diagram-project" aria-hidden="true"></i>
            {{ 'people.ancestors.viewFamilyTree' | translate }}
          </button>
          @if (rootPersons().length > 0) {
            <button class="ancestors-hero__toggle" [attr.aria-label]="heroCollapsed() ? 'Expand' : 'Collapse'">
              <i class="fa-solid" [class.fa-chevron-down]="heroCollapsed()" [class.fa-chevron-up]="!heroCollapsed()" aria-hidden="true"></i>
            </button>
          }
        </div>
      </div>

      <!-- Ancestor Cards (collapsible, only when ancestors exist) -->
      @if (rootPersons().length > 0 && !heroCollapsed()) {
        <div class="ancestors-hero__content">
          <div class="ancestors-hero__persons">
            @for (person of rootPersons(); track person.id; let i = $index) {
              <div
                class="ancestor-card"
                [class]="'ancestor-card--' + getGenderClass(person.sex)"
                (click)="viewAncestor(person)">

                <!-- Avatar -->
                <div class="ancestor-card__avatar"
                     [class.ancestor-card__avatar--male]="person.sex === Sex.Male"
                     [class.ancestor-card__avatar--female]="person.sex === Sex.Female">
                  @if (getAncestorAvatarUrl(person.id)) {
                    <img [src]="getAncestorAvatarUrl(person.id)" [alt]="getAncestorName(person)" class="ancestor-card__avatar-img">
                  } @else {
                    <i class="fa-solid" [class.fa-mars]="person.sex === Sex.Male" [class.fa-venus]="person.sex === Sex.Female" [class.fa-user]="person.sex !== Sex.Male && person.sex !== Sex.Female" aria-hidden="true"></i>
                  }
                </div>

                <!-- Info -->
                <div class="ancestor-card__info">
                  <span class="ancestor-card__name">{{ getAncestorName(person) }}</span>
                  <div class="ancestor-card__stats">
                    @if (person.descendantCount > 0) {
                      <span class="ancestor-card__stat">
                        <i class="fa-solid fa-users" aria-hidden="true"></i>
                        {{ person.descendantCount }}
                      </span>
                    }
                    @if (person.generationDepth > 0) {
                      <span class="ancestor-card__stat">
                        <i class="fa-solid fa-layer-group" aria-hidden="true"></i>
                        {{ person.generationDepth }}
                      </span>
                    }
                    @if (person.childCount > 0) {
                      <span class="ancestor-card__stat">
                        <i class="fa-solid fa-child" aria-hidden="true"></i>
                        {{ person.childCount }}
                      </span>
                    }
                  </div>
                </div>

                <!-- Arrow -->
                <i class="fa-solid fa-chevron-right ancestor-card__arrow" aria-hidden="true"></i>
              </div>
            }
          </div>

          <!-- View Tree Link (moved to header) -->
        </div>
      }
    </div>
  }

  <!-- Search & Filters -->
  <div class="people-page__toolbar">
    <div class="ft-search">
      <i class="fa-solid fa-magnifying-glass ft-search__icon" aria-hidden="true"></i>
      <input
        type="text"
        class="ft-search__input"
        [placeholder]="'people.searchPlaceholder' | translate"
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearchChange($event)">
      @if (detectedScript() !== 'auto') {
        <span class="ft-search__script-hint">{{ detectedScript() }}</span>
      }
      @if (searchQuery) {
        <button class="ft-search__clear" (click)="clearSearch()">
          <i class="fa-solid fa-xmark" aria-hidden="true"></i>
        </button>
      }
    </div>

    <div class="ft-filter-group">
      <!-- Sex Filter -->
      <button
        class="ft-chip"
        [class.ft-chip--active]="filters().sex === null"
        (click)="setFilter('sex', null)">
        {{ 'common.all' | translate }}
      </button>
      <button
        class="ft-chip"
        [class.ft-chip--active]="filters().sex === Sex.Male"
        (click)="setFilter('sex', Sex.Male)">
        <i class="fa-solid fa-mars ft-chip__icon" aria-hidden="true"></i>
        {{ 'people.male' | translate }}
      </button>
      <button
        class="ft-chip"
        [class.ft-chip--active]="filters().sex === Sex.Female"
        (click)="setFilter('sex', Sex.Female)">
        <i class="fa-solid fa-venus ft-chip__icon" aria-hidden="true"></i>
        {{ 'people.female' | translate }}
      </button>

      <!-- Status Filter -->
      <button
        class="ft-chip"
        [class.ft-chip--active]="filters().status === 'living'"
        (click)="setFilter('status', filters().status === 'living' ? 'all' : 'living')">
        {{ 'people.living' | translate }}
      </button>
      <button
        class="ft-chip"
        [class.ft-chip--active]="filters().status === 'deceased'"
        (click)="setFilter('status', filters().status === 'deceased' ? 'all' : 'deceased')">
        {{ 'people.deceased' | translate }}
      </button>
    </div>
  </div>

  <!-- Content -->
  <div class="people-page__content">
    @if (loading()) {
      <!-- Loading Skeletons -->
      <div class="people-grid">
        @for (i of [1,2,3,4,5,6]; track i) {
          <app-skeleton type="person-card" [class]="'ft-fade-in ft-stagger-' + i"></app-skeleton>
        }
      </div>
    } @else if (people().length === 0) {
      <!-- Empty State -->
      <app-empty-state
        icon="fa-users"
        [title]="hasActiveFilters() ? ('common.noResults' | translate) : ('people.noPeople' | translate)"
        [description]="hasActiveFilters() ? '' : ('people.addFirst' | translate)">
        @if (!hasActiveFilters()) {
          <button mat-flat-button color="primary" (click)="openPersonForm()">
            <i class="fa-solid fa-plus" aria-hidden="true"></i>
            {{ 'people.addPerson' | translate }}
          </button>
        } @else {
          <button mat-stroked-button (click)="clearFilters()">
            {{ 'common.filter' | translate }} {{ 'common.cancel' | translate }}
          </button>
        }
      </app-empty-state>
    } @else {
      <!-- People Grid -->
      <div class="people-grid">
        @for (person of people(); track person.id; let i = $index) {
          <div
            class="ft-person-card ft-fade-in"
            [class]="'ft-stagger-' + (i % 10 + 1)"
            matRipple
            (click)="viewPerson(person)">

            <!-- Avatar -->
            <div
              class="ft-avatar ft-avatar--lg"
              [class.ft-avatar--male]="person.sex === Sex.Male"
              [class.ft-avatar--female]="person.sex === Sex.Female"
              [class.ft-avatar--unknown]="person.sex === Sex.Unknown"
              [class.ft-avatar--has-image]="getAvatarUrl(person.id)">
              @if (getAvatarUrl(person.id)) {
                <img [src]="getAvatarUrl(person.id)" [alt]="getPersonOwnName(person)" class="ft-avatar__img">
              } @else {
                {{ getInitials(getPersonOwnName(person)) }}
              }
            </div>

            <!-- Content -->
            <div class="ft-person-card__content">
              <h3 class="ft-person-card__name">{{ getPersonName(person) }}</h3>

              <!-- Show secondary names if available -->
              @if (hasSecondaryNames(person)) {
                <div class="ft-person-card__alt-names">
                  @for (name of getSecondaryNames(person); track $index) {
                    <span class="ft-person-card__alt-name">{{ name }}</span>
                  }
                </div>
              }

              <div class="ft-person-card__meta">
                @if (person.birthDate) {
                  <span class="ft-person-card__meta-item">
                    <i class="fa-solid fa-cake-candles" aria-hidden="true"></i>
                    {{ formatDate(person.birthDate) }}
                  </span>
                }
                @if (person.deathDate) {
                  <span class="ft-person-card__meta-item">
                    <i class="fa-solid fa-clock" aria-hidden="true"></i>
                    {{ formatDate(person.deathDate) }}
                  </span>
                }
                @if (person.birthPlaceName) {
                  <span class="ft-person-card__meta-item">
                    <i class="fa-solid fa-location-dot" aria-hidden="true"></i>
                    {{ person.birthPlaceName }}
                  </span>
                }
                @if (person.treeName) {
                  <span class="ft-person-card__meta-item ft-person-card__meta-item--tree">
                    <i class="fa-solid fa-sitemap" aria-hidden="true"></i>
                    {{ person.treeName }}
                  </span>
                }
                @if (getLocationDisplayName(person)) {
                  <span class="ft-person-card__meta-item ft-person-card__meta-item--town">
                    <i class="fa-solid fa-city" aria-hidden="true"></i>
                    {{ getLocationDisplayName(person) }}
                  </span>
                }
              </div>

              <!-- Relationship counts -->
              <div class="ft-person-card__counts">
                @if (person.parentsCount > 0) {
                  <span class="ft-badge ft-badge--info" matTooltip="Parents">
                    <i class="fa-solid fa-user-tie" aria-hidden="true"></i> {{ person.parentsCount }}
                  </span>
                }
                @if (person.childrenCount > 0) {
                  <span class="ft-badge ft-badge--info" matTooltip="Children">
                    <i class="fa-solid fa-child" aria-hidden="true"></i> {{ person.childrenCount }}
                  </span>
                }
                @if (person.spousesCount > 0) {
                  <span class="ft-badge ft-badge--info" matTooltip="Spouses">
                    <i class="fa-solid fa-heart" aria-hidden="true"></i> {{ person.spousesCount }}
                  </span>
                }
              </div>

              <!-- Badges -->
              <div class="ft-person-card__badges">
                @if (person.mediaCount > 0) {
                  <span class="ft-badge ft-badge--media ft-badge--clickable"
                        [matTooltip]="person.mediaCount + ' media files - Click to view'"
                        (click)="viewPersonMedia(person, $event)">
                    <i class="fa-solid fa-camera" aria-hidden="true" style="font-size: 12px;"></i>
                    {{ person.mediaCount }}
                  </span>
                }
                @if (person.isLiving) {
                  <span class="ft-badge ft-badge--success">{{ 'people.living' | translate }}</span>
                }
              </div>
            </div>

            <!-- Actions Menu -->
            <div class="ft-person-card__actions" (click)="$event.stopPropagation()">
              <button mat-icon-button [matMenuTriggerFor]="personMenu">
                <i class="fa-solid fa-ellipsis-vertical" aria-hidden="true"></i>
              </button>
              <mat-menu #personMenu="matMenu">
                <button mat-menu-item (click)="viewPerson(person)">
                  <i class="fa-solid fa-eye" aria-hidden="true"></i>
                  <span>{{ 'people.viewProfile' | translate }}</span>
                </button>
                <button mat-menu-item (click)="editPerson(person)">
                  <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
                  <span>{{ 'common.edit' | translate }}</span>
                </button>
                <button mat-menu-item (click)="viewInTree(person)">
                  <i class="fa-solid fa-sitemap" aria-hidden="true"></i>
                  <span>{{ 'people.viewInTree' | translate }}</span>
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item class="text-error" (click)="deletePerson(person)">
                  <i class="fa-solid fa-trash" aria-hidden="true"></i>
                  <span>{{ 'common.delete' | translate }}</span>
                </button>
              </mat-menu>
            </div>
          </div>
        }
      </div>

      <!-- Load More -->
      @if (hasMore()) {
        <div class="people-page__load-more">
          <button mat-stroked-button (click)="loadMore()" [disabled]="loadingMore()">
            @if (loadingMore()) {
              <i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i>
            }
            {{ 'common.loadMore' | translate }}
          </button>
        </div>
      }
    }
  </div>

  <!-- Mobile FAB -->
  <button
    mat-fab
    color="primary"
    class="people-page__fab d-desktop-none"
    (click)="openPersonForm()">
    <i class="fa-solid fa-plus" aria-hidden="true"></i>
  </button>
</div>

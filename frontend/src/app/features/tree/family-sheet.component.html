<div class="family-sheet">
  @if (person) {
    <!-- Parent's Family Section -->
    @if (parentFamily()) {
      <mat-card class="family-sheet__section family-sheet__section--parents">
        <mat-card-header>
          <mat-card-title>
            <i class="fa-solid fa-users" aria-hidden="true"></i>
            {{ 'familySheet.title' | translate }} - {{ 'timeline.parents' | translate }}
          </mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <!-- Parents Row -->
          <div class="family-sheet__parents-row">
            <!-- Parent 1 (Father) -->
            <div class="family-sheet__parent"
                 [class.family-sheet__parent--selected]="parentFamily()!.partner1?.id === selectedPersonId"
                 (click)="parentFamily()!.partner1 && onPersonClick(parentFamily()!.partner1!)"
                 (dblclick)="parentFamily()!.partner1 && onPersonDoubleClick(parentFamily()!.partner1!)">
              <div class="family-sheet__avatar"
                   [class.family-sheet__avatar--male]="isMale(parentFamily()!.partner1)"
                   [class.family-sheet__avatar--female]="isFemale(parentFamily()!.partner1)">
                @if (parentFamily()!.partner1 && getAvatarUrl(parentFamily()!.partner1!.id)) {
                  <img [src]="getAvatarUrl(parentFamily()!.partner1!.id)" [alt]="getDisplayName(parentFamily()!.partner1)">
                } @else {
                  {{ getInitials(parentFamily()!.partner1) }}
                }
              </div>
              <div class="family-sheet__person-info">
                <span class="family-sheet__role">{{ getRoleLabel(parentFamily()!.partner1, true) }}</span>
                <span class="family-sheet__name">{{ getDisplayName(parentFamily()!.partner1) }}</span>
                @if (parentFamily()!.partner1?.birthDate) {
                  <span class="family-sheet__dates">
                    {{ 'familySheet.born' | translate }}: {{ formatDate(parentFamily()!.partner1?.birthDate) }}
                  </span>
                }
                @if (parentFamily()!.partner1?.deathDate) {
                  <span class="family-sheet__dates">
                    {{ 'familySheet.died' | translate }}: {{ formatDate(parentFamily()!.partner1?.deathDate) }}
                  </span>
                }
              </div>
            </div>

            <!-- Marriage Connector -->
            <div class="family-sheet__marriage-connector">
              <div class="family-sheet__marriage-icon">
                <i class="fa-solid fa-rings-wedding" aria-hidden="true"></i>
              </div>
              @if (parentFamily()!.union?.startDate) {
                <span class="family-sheet__marriage-date">
                  {{ formatDate(parentFamily()!.union?.startDate) }}
                </span>
              }
            </div>

            <!-- Parent 2 (Mother) -->
            <div class="family-sheet__parent"
                 [class.family-sheet__parent--selected]="parentFamily()!.partner2?.id === selectedPersonId"
                 (click)="parentFamily()!.partner2 && onPersonClick(parentFamily()!.partner2!)"
                 (dblclick)="parentFamily()!.partner2 && onPersonDoubleClick(parentFamily()!.partner2!)">
              <div class="family-sheet__avatar"
                   [class.family-sheet__avatar--male]="isMale(parentFamily()!.partner2)"
                   [class.family-sheet__avatar--female]="isFemale(parentFamily()!.partner2)">
                @if (parentFamily()!.partner2 && getAvatarUrl(parentFamily()!.partner2!.id)) {
                  <img [src]="getAvatarUrl(parentFamily()!.partner2!.id)" [alt]="getDisplayName(parentFamily()!.partner2)">
                } @else {
                  {{ getInitials(parentFamily()!.partner2) }}
                }
              </div>
              <div class="family-sheet__person-info">
                <span class="family-sheet__role">{{ getRoleLabel(parentFamily()!.partner2, true) }}</span>
                <span class="family-sheet__name">{{ getDisplayName(parentFamily()!.partner2) }}</span>
                @if (parentFamily()!.partner2?.birthDate) {
                  <span class="family-sheet__dates">
                    {{ 'familySheet.born' | translate }}: {{ formatDate(parentFamily()!.partner2?.birthDate) }}
                  </span>
                }
                @if (parentFamily()!.partner2?.deathDate) {
                  <span class="family-sheet__dates">
                    {{ 'familySheet.died' | translate }}: {{ formatDate(parentFamily()!.partner2?.deathDate) }}
                  </span>
                }
              </div>
            </div>
          </div>

          <!-- Siblings -->
          @if (parentFamily()!.children.length > 0) {
            <mat-divider></mat-divider>
            <div class="family-sheet__children">
              <h4 class="family-sheet__children-title">
                {{ 'familySheet.children' | translate }} ({{ parentFamily()!.children.length }})
              </h4>
              <div class="family-sheet__children-list">
                @for (child of parentFamily()!.children; track child.id; let i = $index) {
                  <div class="family-sheet__child"
                       [class.family-sheet__child--selected]="child.id === selectedPersonId"
                       [class.family-sheet__child--current]="child.id === person.id"
                       (click)="onPersonClick(child)"
                       (dblclick)="onPersonDoubleClick(child)">
                    <span class="family-sheet__child-number">{{ i + 1 }}.</span>
                    <div class="family-sheet__avatar family-sheet__avatar--small"
                         [class.family-sheet__avatar--male]="isMale(child)"
                         [class.family-sheet__avatar--female]="isFemale(child)">
                      @if (getAvatarUrl(child.id)) {
                        <img [src]="getAvatarUrl(child.id)" [alt]="getDisplayName(child)">
                      } @else {
                        {{ getInitials(child) }}
                      }
                    </div>
                    <div class="family-sheet__child-info">
                      <span class="family-sheet__child-name">
                        {{ getDisplayName(child) }}
                        @if (child.id === person.id) {
                          <span class="family-sheet__current-badge">★</span>
                        }
                      </span>
                      <span class="family-sheet__child-dates">
                        @if (child.birthDate) {
                          {{ formatYear(child.birthDate) }}
                        }
                        @if (child.birthDate && child.deathDate) {
                          -
                        }
                        @if (child.deathDate) {
                          {{ formatYear(child.deathDate) }}
                        }
                        @if (child.isLiving && child.birthDate) {
                          ({{ calculateAge(child.birthDate, undefined) }} {{ 'timeline.yearsOld' | translate }})
                        }
                      </span>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </mat-card-content>
      </mat-card>
    }

    <!-- Person's Own Family Section -->
    @if (ownFamily()) {
      <mat-card class="family-sheet__section family-sheet__section--own">
        <mat-card-header>
          <mat-card-title>
            <i class="fa-solid fa-house-chimney-user" aria-hidden="true"></i>
            {{ 'familySheet.title' | translate }}
          </mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <!-- Spouse Row -->
          <div class="family-sheet__parents-row">
            <!-- Partner 1 (Husband) -->
            <div class="family-sheet__parent"
                 [class.family-sheet__parent--selected]="ownFamily()!.partner1?.id === selectedPersonId"
                 [class.family-sheet__parent--current]="ownFamily()!.partner1?.id === person.id"
                 (click)="ownFamily()!.partner1 && onPersonClick(ownFamily()!.partner1!)"
                 (dblclick)="ownFamily()!.partner1 && onPersonDoubleClick(ownFamily()!.partner1!)">
              <div class="family-sheet__avatar"
                   [class.family-sheet__avatar--male]="isMale(ownFamily()!.partner1)"
                   [class.family-sheet__avatar--female]="isFemale(ownFamily()!.partner1)">
                @if (ownFamily()!.partner1 && getAvatarUrl(ownFamily()!.partner1!.id)) {
                  <img [src]="getAvatarUrl(ownFamily()!.partner1!.id)" [alt]="getDisplayName(ownFamily()!.partner1)">
                } @else {
                  {{ getInitials(ownFamily()!.partner1) }}
                }
              </div>
              <div class="family-sheet__person-info">
                <span class="family-sheet__role">{{ getRoleLabel(ownFamily()!.partner1, false) }}</span>
                <span class="family-sheet__name">
                  {{ getDisplayName(ownFamily()!.partner1) }}
                  @if (ownFamily()!.partner1?.id === person.id) {
                    <span class="family-sheet__current-badge">★</span>
                  }
                </span>
                @if (ownFamily()!.partner1?.birthDate) {
                  <span class="family-sheet__dates">
                    {{ 'familySheet.born' | translate }}: {{ formatDate(ownFamily()!.partner1?.birthDate) }}
                  </span>
                }
                @if (ownFamily()!.partner1?.deathDate) {
                  <span class="family-sheet__dates">
                    {{ 'familySheet.died' | translate }}: {{ formatDate(ownFamily()!.partner1?.deathDate) }}
                  </span>
                }
              </div>
              @if (ownFamily()!.partner1) {
                <button class="family-sheet__edit-btn"
                        mat-icon-button
                        (click)="onPersonEdit(ownFamily()!.partner1!, $event)"
                        [matTooltip]="'common.edit' | translate">
                  <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
                </button>
              }
            </div>

            <!-- Marriage Connector -->
            <div class="family-sheet__marriage-connector">
              <div class="family-sheet__marriage-icon">
                <i class="fa-solid fa-rings-wedding" aria-hidden="true"></i>
              </div>
              @if (ownFamily()!.union?.startDate) {
                <span class="family-sheet__marriage-date">
                  {{ formatDate(ownFamily()!.union?.startDate) }}
                </span>
              }
            </div>

            <!-- Partner 2 (Wife) -->
            <div class="family-sheet__parent"
                 [class.family-sheet__parent--selected]="ownFamily()!.partner2?.id === selectedPersonId"
                 [class.family-sheet__parent--current]="ownFamily()!.partner2?.id === person.id"
                 (click)="ownFamily()!.partner2 && onPersonClick(ownFamily()!.partner2!)"
                 (dblclick)="ownFamily()!.partner2 && onPersonDoubleClick(ownFamily()!.partner2!)">
              <div class="family-sheet__avatar"
                   [class.family-sheet__avatar--male]="isMale(ownFamily()!.partner2)"
                   [class.family-sheet__avatar--female]="isFemale(ownFamily()!.partner2)">
                @if (ownFamily()!.partner2 && getAvatarUrl(ownFamily()!.partner2!.id)) {
                  <img [src]="getAvatarUrl(ownFamily()!.partner2!.id)" [alt]="getDisplayName(ownFamily()!.partner2)">
                } @else {
                  {{ getInitials(ownFamily()!.partner2) }}
                }
              </div>
              <div class="family-sheet__person-info">
                <span class="family-sheet__role">{{ getRoleLabel(ownFamily()!.partner2, false) }}</span>
                <span class="family-sheet__name">
                  {{ getDisplayName(ownFamily()!.partner2) }}
                  @if (ownFamily()!.partner2?.id === person.id) {
                    <span class="family-sheet__current-badge">★</span>
                  }
                </span>
                @if (ownFamily()!.partner2?.birthDate) {
                  <span class="family-sheet__dates">
                    {{ 'familySheet.born' | translate }}: {{ formatDate(ownFamily()!.partner2?.birthDate) }}
                  </span>
                }
                @if (ownFamily()!.partner2?.deathDate) {
                  <span class="family-sheet__dates">
                    {{ 'familySheet.died' | translate }}: {{ formatDate(ownFamily()!.partner2?.deathDate) }}
                  </span>
                }
              </div>
              @if (ownFamily()!.partner2) {
                <button class="family-sheet__edit-btn"
                        mat-icon-button
                        (click)="onPersonEdit(ownFamily()!.partner2!, $event)"
                        [matTooltip]="'common.edit' | translate">
                  <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
                </button>
              }
            </div>
          </div>

          <!-- Children -->
          @if (ownFamily()!.children.length > 0) {
            <mat-divider></mat-divider>
            <div class="family-sheet__children">
              <h4 class="family-sheet__children-title">
                {{ 'familySheet.children' | translate }} ({{ ownFamily()!.children.length }})
              </h4>
              <div class="family-sheet__children-list">
                @for (child of ownFamily()!.children; track child.id; let i = $index) {
                  <div class="family-sheet__child"
                       [class.family-sheet__child--selected]="child.id === selectedPersonId"
                       (click)="onPersonClick(child)"
                       (dblclick)="onPersonDoubleClick(child)">
                    <span class="family-sheet__child-number">{{ i + 1 }}.</span>
                    <div class="family-sheet__avatar family-sheet__avatar--small"
                         [class.family-sheet__avatar--male]="isMale(child)"
                         [class.family-sheet__avatar--female]="isFemale(child)">
                      @if (getAvatarUrl(child.id)) {
                        <img [src]="getAvatarUrl(child.id)" [alt]="getDisplayName(child)">
                      } @else {
                        {{ getInitials(child) }}
                      }
                    </div>
                    <div class="family-sheet__child-info">
                      <span class="family-sheet__child-name">{{ getDisplayName(child) }}</span>
                      <span class="family-sheet__child-dates">
                        @if (child.birthDate) {
                          {{ formatYear(child.birthDate) }}
                        }
                        @if (child.birthDate && child.deathDate) {
                          -
                        }
                        @if (child.deathDate) {
                          {{ formatYear(child.deathDate) }}
                        }
                        @if (child.isLiving && child.birthDate) {
                          ({{ calculateAge(child.birthDate, undefined) }} {{ 'timeline.yearsOld' | translate }})
                        }
                      </span>
                    </div>
                  </div>
                }
              </div>
            </div>
          } @else {
            <mat-divider></mat-divider>
            <div class="family-sheet__no-children">
              <i class="fa-solid fa-child" aria-hidden="true"></i>
              <span>{{ 'familySheet.noChildren' | translate }}</span>
            </div>
          }
        </mat-card-content>
      </mat-card>
    }
  } @else {
    <div class="family-sheet__empty">
      <i class="fa-solid fa-users-slash" aria-hidden="true"></i>
      <p>{{ 'tree.selectPerson' | translate }}</p>
    </div>
  }
</div>
